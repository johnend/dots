#######################################
# QMK compile repo based
#######################################
function compile_qmk() {
  # Get the root directory of the current Git repo
  REPO_NAME=$(basename $(git rev-parse --show-toplevel) 2>/dev/null)

  # If we're not in a git repo, exit
  if [ -z "$REPO_NAME" ]; then
    echo "Error: Not a git repo"
    exit 1
  fi

  # Choose the compile command based on the repo name
  if [ "$REPO_NAME" = "vial-qmk" ]; then
    echo "Compiling firmware for Cyboard Imprint..."
    qmk compile -kb cyboard/imprint/imprint_number_row -km qc
  elif [ "$REPO_NAME" = "qmk_firmware" ]; then
    echo "Compiling firmware for Sofle..."
    qmk compile -kb sofle/rev1 -km johnend
  else
    echo "Error: Unknown repo"
    exit 1
  fi
}

#######################################
# Yarn and NPM script runner with fzf
#######################################
function run() {
  # Detect and run scripts for JS/TS and Python projects
  if [[ -f package.json ]]; then
    scripts=$(jq -r '.scripts | to_entries[] | "\(.key): \(.value)"' package.json | fzf --height 40%)
    if [[ -n $scripts ]]; then
      script_name=$(echo $scripts | awk -F ':' '{print $1}' | xargs)
      if [[ -f yarn.lock ]]; then
        print -s "yarn run $script_name"
        yarn run $script_name
      elif [[ -f package-lock.json ]]; then
        print -s "npm run $script_name"
        npm run $script_name
      elif [[ -f pnpm-lock.yaml ]]; then
        print -s "pnpm run $script_name"
        pnpm run $script_name
      elif [[ -f bun.lockb ]]; then
        print -s "bun run $script_name"
        bun run $script_name
      elif [[ -f deno.json || -f deno.jsonc ]]; then
        print -s "deno task $script_name"
        deno task $script_name
      else
        echo "No recognized JS/TS package manager lockfile found."
      fi
    else
      echo "Nothing selected. Exiting ðŸ‘‹"
    fi

  else
    echo "ðŸš¨ Error: could not find package.json or pyproject.toml"
  fi
}

#######################################
# Make homebrew act like yay
#######################################
function brzf() {
  if [[ "$OSTYPE" != "darwin"* ]]; then
    echo "brzf is only available on macOS."
    return 1
  fi

  if ! command -v brew &>/dev/null; then
    echo "Homebrew is not installed."
    return 1
  fi

  local cmd=""
  local arg=""

  while [[ "$#" -gt 0 ]]; do
    case "$1" in
    --rm | -r)
      cmd="uninstall"
      ;;
    --cask | -c)
      cmd="cask"
      ;;
    --help | -h)
      echo "brzf: Interactive Homebrew with fuzzy search"
      echo ""
      echo "Usage:"
      echo "  brzf [query]             Search and install package (default)"
      echo "  brzf -r | --rm           Fuzzy uninstall installed package"
      echo "  brzf -c | --cask [query] Search and install GUI app (cask)"
      echo "  brzf -h | --help         Show this help message"
      return 0
      ;;
    *)
      arg="$1"
      ;;
    esac
    shift
  done

  case "$cmd" in
  uninstall)
    local choice
    choice=$(brew list | fzf --ansi --height=40% --prompt="âŒ brzf: Uninstall > " --preview 'echo {}')
    [[ -n "$choice" ]] && echo "ðŸ§¼ Uninstalling $choice..." && brew uninstall "$choice" || echo "âŒ No package selected."
    ;;

  cask)
    local choice
    choice=$(brew search --casks --desc "$arg" 2>&1 | grep -v 'Warning: Use `--eval-all`' | awk '{printf "\033[1m%s\033[0m \033[2m%s\033[0m\n", $1, substr($0, index($0,$2))}' | fzf --ansi --height=40% --prompt="ðŸ–¥ï¸ brzf: Cask > ")
    [[ -n "$choice" ]] && pkg=$(echo "$choice" | awk '{print $1}' | sed 's/:$//') && echo "ðŸ“¦ Installing cask: $pkg..." && brew install --cask "$pkg" || echo "âŒ No cask selected."
    ;;

  *)
    local choice
    choice=$(brew search --desc "$arg" 2>&1 | grep -v 'Warning: Use `--eval-all`' | awk '{printf "\033[1m%s\033[0m \033[2m%s\033[0m\n", $1, substr($0, index($0,$2))}' | fzf --ansi --height=40% --prompt="ðŸº brzf: Install > ")
    [[ -n "$choice" ]] && pkg=$(echo "$choice" | awk '{print $1}' | sed 's/:$//') && echo "ðŸ”§ Installing $pkg..." && brew install "$pkg" || echo "âŒ No package selected."
    ;;
  esac
}

#######################################
# Clone repo with fzf
#######################################

function cloner() {
  if ! command -v gh &>/dev/null; then
    echo "GitHub CLI is not installed."
    return 1
  fi

  local choice
  choice=$(gh repo list | awk '{printf "\033[1m%s\033[0m \033[2m%s\033[0m\n", $1, substr($0, index($0,$2))}' | fzf --ansi --height=40% --prompt="Choose a repo to clone:" --preview 'echo {}')

  [[ -n "$choice" ]] && repo=$(echo "$choice" | awk '{print $1}') && echo "Cloning $repo..." && gh repo clone "$repo" || echo "No repo selected."
}
